# StockManager 單元測試摘要

## 測試檔案
`tests/managers/StockManager.test.ts`

## 測試範圍

### 1. CRUD 操作測試

#### addStock - 新增股票
- ✅ 應該成功新增有效的股票
- ✅ 應該在沒有股票名稱時自動查詢
- ✅ 應該拒絕無效的股票代碼
- ✅ 應該拒絕負數的持股數
- ✅ 應該拒絕負數的成本價
- ✅ 應該拒絕未來的購買日期

#### getStock - 取得單一股票
- ✅ 應該返回存在的股票
- ✅ 應該對不存在的股票返回 null

#### getAllStocks - 取得所有股票
- ✅ 應該返回空陣列當沒有股票時
- ✅ 應該返回所有已新增的股票

#### getStocksByAccount - 取得指定帳戶的股票
- ✅ 應該只返回指定帳戶的股票
- ✅ 應該返回空陣列當帳戶沒有股票時

#### updateStock - 更新股票
- ✅ 應該成功更新股票資訊
- ✅ 應該拒絕更新不存在的股票
- ✅ 應該驗證更新的資料

#### deleteStock - 刪除股票
- ✅ 應該成功刪除存在的股票
- ✅ 應該拒絕刪除不存在的股票

### 2. 股價更新測試

#### updateStockPrice - 更新單一股票股價
- ✅ 應該成功更新股票股價
- ✅ 應該拒絕更新不存在的股票
- ✅ 應該處理 API 錯誤

#### updateAllPrices - 批次更新所有股價
- ✅ 應該成功更新所有股票股價
- ✅ 應該處理部分失敗的情況
- ✅ 應該返回空結果當沒有股票時

### 3. 錯誤處理測試

- ✅ 應該處理儲存失敗的情況
- ✅ 應該處理載入資料失敗的情況
- ✅ 應該處理載入損壞的資料

### 4. 資料持久化測試

- ✅ 應該在初始化時載入現有資料
- ✅ 應該在每次修改後儲存資料

## 測試統計

- **總測試案例數**: 27
- **測試群組數**: 4 個主要群組
  - CRUD 操作: 15 個測試
  - 股價更新: 6 個測試
  - 錯誤處理: 3 個測試
  - 資料持久化: 2 個測試

## 測試覆蓋範圍

### 功能覆蓋
- ✅ 股票新增（包含驗證）
- ✅ 股票查詢（單一、全部、按帳戶）
- ✅ 股票更新（包含驗證）
- ✅ 股票刪除
- ✅ 股價更新（單一和批次）
- ✅ 錯誤處理
- ✅ 資料持久化

### 驗證覆蓋
- ✅ 股票代碼驗證
- ✅ 持股數驗證
- ✅ 成本價驗證
- ✅ 現價驗證
- ✅ 購買日期驗證

### 錯誤情境覆蓋
- ✅ 不存在的股票操作
- ✅ 無效的輸入資料
- ✅ API 呼叫失敗
- ✅ 儲存失敗
- ✅ 載入失敗
- ✅ 損壞的資料

## Mock 使用

### StockApiService Mock
- `searchStockByCode()` - 模擬股票名稱查詢
- `getStockPrice()` - 模擬股價查詢

### StorageService Mock
- `load()` - 模擬資料載入
- `save()` - 模擬資料儲存

## 測試策略

1. **隔離測試**: 使用 Jest mock 隔離外部依賴
2. **正向測試**: 驗證正常流程的功能
3. **負向測試**: 驗證錯誤處理和邊界條件
4. **整合測試**: 驗證多個操作的協作

## 執行測試

```bash
# 執行所有測試
npm test

# 執行 StockManager 測試
npm test -- StockManager.test.ts

# 執行測試並顯示覆蓋率
npm run test:coverage

# 監視模式
npm run test:watch
```

## 需求驗證

本測試套件驗證了以下需求：

- **Requirements 7.1**: 股票管理功能
  - ✅ 股票 CRUD 操作
  - ✅ 股價更新（單一和批次）
  - ✅ 股票查詢和篩選
  - ✅ 錯誤處理
  - ✅ 資料持久化

## 注意事項

1. 測試使用 Jest mock 模擬外部服務，確保測試的獨立性
2. 所有驗證邏輯都經過測試，包含正向和負向案例
3. 批次更新使用 Promise.allSettled，確保部分失敗不影響其他股票
4. 錯誤處理涵蓋各種失敗情境
5. 資料持久化在每次修改後自動執行

## 測試品質

- ✅ 無 TypeScript 診斷錯誤
- ✅ 遵循 AAA 模式（Arrange-Act-Assert）
- ✅ 清晰的測試描述
- ✅ 完整的斷言
- ✅ 適當的 mock 使用
- ✅ 涵蓋核心功能和邊界條件
