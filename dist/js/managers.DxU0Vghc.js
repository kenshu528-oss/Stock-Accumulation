var E=Object.defineProperty;var $=(l,t,e)=>t in l?E(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var f=(l,t,e)=>$(l,typeof t!="symbol"?t+"":t,e);class S extends Error{constructor(e,o,a){super(e);f(this,"code");f(this,"details");this.name="StockError",this.code=o,this.details=a,Error.captureStackTrace&&Error.captureStackTrace(this,S)}}class A extends S{constructor(e,o){super(e,"API_ERROR");f(this,"statusCode");this.name="ApiError",this.statusCode=o,Error.captureStackTrace&&Error.captureStackTrace(this,A)}}class c extends S{constructor(e,o){super(e,"VALIDATION_ERROR");f(this,"field");this.name="ValidationError",this.field=o,Error.captureStackTrace&&Error.captureStackTrace(this,c)}}class P extends S{constructor(t){super(t,"STORAGE_ERROR"),this.name="StorageError",Error.captureStackTrace&&Error.captureStackTrace(this,P)}}const T="modulepreload",O=function(l,t){return new URL(l,t).href},k={},D=function(t,e,o){let a=Promise.resolve();if(e&&e.length>0){const n=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),d=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));a=Promise.allSettled(e.map(s=>{if(s=O(s,o),s in k)return;k[s]=!0;const g=s.endsWith(".css"),v=g?'[rel="stylesheet"]':"";if(!!o)for(let h=n.length-1;h>=0;h--){const m=n[h];if(m.href===s&&(!g||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${s}"]${v}`))return;const u=document.createElement("link");if(u.rel=g?"stylesheet":T,g||(u.as="script"),u.crossOrigin="",u.href=s,d&&u.setAttribute("nonce",d),document.head.appendChild(u),g)return new Promise((h,m)=>{u.addEventListener("load",h),u.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${s}`)))})}))}function i(n){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=n,window.dispatchEvent(r),!r.defaultPrevented)throw n}return a.then(n=>{for(const r of n||[])r.status==="rejected"&&i(r.reason);return t().catch(i)})};class R{constructor(t,e){f(this,"stocks",new Map);this.apiService=t,this.storageService=e,this.loadFromStorage()}loadFromStorage(){try{const t=this.storageService.load();if(t&&t.stocks){for(const e of t.stocks)this.stocks.set(e.id,e);console.log(`已載入 ${this.stocks.size} 筆股票資料`)}else console.log("無現有股票資料，從空白狀態開始")}catch(t){console.error("載入股票資料失敗:",t),this.stocks.clear()}}saveToStorage(){try{const t=this.storageService.load()||this.createEmptyPortfolioData();t.stocks=Array.from(this.stocks.values()),this.storageService.save(t),console.log(`已儲存 ${this.stocks.size} 筆股票資料`)}catch(t){throw console.error("儲存股票資料失敗:",t),new S("儲存股票資料失敗","STORAGE_ERROR")}}createEmptyPortfolioData(){return{version:"1.3.0",accounts:[],stocks:[],dividends:[],settings:{privacyMode:!1,darkMode:!1,autoUpdate:!1,updateInterval:3e5,cloudSync:{enabled:!1}},metadata:{createdAt:new Date().toISOString(),lastModified:new Date().toISOString()}}}generateStockId(){return`stock_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async addStock(t){const{validateStockCode:e,validateAmount:o,validateShares:a,validateDate:i}=await D(async()=>{const{validateStockCode:h,validateAmount:m,validateShares:p,validateDate:y}=await import("./validators._HnbLAi4.js");return{validateStockCode:h,validateAmount:m,validateShares:p,validateDate:y}},[],import.meta.url),n=e(t.code);if(!n.valid)throw new c(n.error||"股票代碼格式錯誤","code");const r=a(t.shares);if(!r.valid)throw new c(r.error||"持股數格式錯誤","shares");const d=o(t.costPrice);if(!d.valid)throw new c(d.error||"成本價格式錯誤","costPrice");const s=o(t.currentPrice,!0);if(!s.valid)throw new c(s.error||"現價格式錯誤","currentPrice");const g=i(t.purchaseDate,{allowFuture:!1});if(!g.valid)throw new c(g.error||"購買日期格式錯誤","purchaseDate");let v=t.name,w=t.dataSource;if(!v||v.trim()===""||v===t.code)try{console.log(`查詢股票名稱: ${t.code}`);const h=await this.apiService.searchStockByCode(t.code);v=h.name,w=h.source,console.log(`✅ 找到股票名稱: ${v}`)}catch(h){console.warn(`無法查詢股票名稱，使用股票代碼: ${h instanceof Error?h.message:String(h)}`),v=t.code}const u={id:this.generateStockId(),code:t.code.trim().toUpperCase(),name:v,shares:t.shares,costPrice:t.costPrice,currentPrice:t.currentPrice,purchaseDate:new Date(t.purchaseDate).toISOString(),accountId:t.accountId,lastUpdated:new Date().toISOString(),dataSource:w};return this.stocks.set(u.id,u),this.saveToStorage(),console.log(`✅ 新增股票成功: ${u.code} - ${u.name}`),u}async updateStock(t,e){const o=this.stocks.get(t);if(!o)throw new S(`股票不存在: ${t}`,"STOCK_NOT_FOUND");const{validateStockCode:a,validateAmount:i,validateShares:n,validateDate:r}=await D(async()=>{const{validateStockCode:s,validateAmount:g,validateShares:v,validateDate:w}=await import("./validators._HnbLAi4.js");return{validateStockCode:s,validateAmount:g,validateShares:v,validateDate:w}},[],import.meta.url);if(e.code!==void 0){const s=a(e.code);if(!s.valid)throw new c(s.error||"股票代碼格式錯誤","code")}if(e.shares!==void 0){const s=n(e.shares);if(!s.valid)throw new c(s.error||"持股數格式錯誤","shares")}if(e.costPrice!==void 0){const s=i(e.costPrice);if(!s.valid)throw new c(s.error||"成本價格式錯誤","costPrice")}if(e.currentPrice!==void 0){const s=i(e.currentPrice,!0);if(!s.valid)throw new c(s.error||"現價格式錯誤","currentPrice")}if(e.purchaseDate!==void 0){const s=r(e.purchaseDate,{allowFuture:!1});if(!s.valid)throw new c(s.error||"購買日期格式錯誤","purchaseDate")}const d={...o,...e,lastUpdated:new Date().toISOString()};return this.stocks.set(t,d),this.saveToStorage(),console.log(`✅ 更新股票成功: ${d.code} - ${d.name}`),d}deleteStock(t){const e=this.stocks.get(t);if(!e)throw new S(`股票不存在: ${t}`,"STOCK_NOT_FOUND");this.stocks.delete(t),this.saveToStorage(),console.log(`✅ 刪除股票成功: ${e.code} - ${e.name}`)}getStock(t){return this.stocks.get(t)||null}getAllStocks(){return Array.from(this.stocks.values())}getStocksByAccount(t){return Array.from(this.stocks.values()).filter(e=>e.accountId===t)}async updateStockPrice(t){const e=this.stocks.get(t);if(!e)throw new S(`股票不存在: ${t}`,"STOCK_NOT_FOUND");try{console.log(`更新股價: ${e.code} - ${e.name}`);const o=await this.apiService.getStockPrice(e.code),a={...e,currentPrice:o.price,dataSource:o.source,lastUpdated:new Date().toISOString()};return this.stocks.set(t,a),this.saveToStorage(),console.log(`✅ 股價更新成功: ${e.code} = ${o.price} (來源: ${o.source})`),a}catch(o){throw console.error(`❌ 股價更新失敗: ${e.code}`,o),new S(`更新股價失敗: ${o instanceof Error?o.message:String(o)}`,"PRICE_UPDATE_FAILED")}}async updateAllPrices(){const t=Array.from(this.stocks.values()),e=t.length;console.log(`開始批次更新 ${e} 支股票的股價...`);const o=await Promise.allSettled(t.map(r=>this.updateStockPrice(r.id)));let a=0,i=0;const n=[];return o.forEach((r,d)=>{const s=t[d];r.status==="fulfilled"?(a++,n.push({stockId:s.id,code:s.code,name:s.name,success:!0,price:r.value.currentPrice})):(i++,n.push({stockId:s.id,code:s.code,name:s.name,success:!1,error:r.reason instanceof Error?r.reason.message:String(r.reason)}))}),console.log(`批次更新完成: 總計 ${e} 支，成功 ${a} 支，失敗 ${i} 支`),{total:e,success:a,failed:i,results:n}}}class M{constructor(t){f(this,"accounts",new Map);this.storageService=t,this.loadAccounts()}loadAccounts(){const t=this.storageService.load();t&&t.accounts&&t.accounts.forEach(e=>{this.accounts.set(e.id,e)})}saveAccounts(){const t=this.storageService.load()||this.createEmptyPortfolioData();t.accounts=Array.from(this.accounts.values()),this.storageService.save(t)}createEmptyPortfolioData(){return{version:"1.3.0",accounts:[],stocks:[],dividends:[],settings:{privacyMode:!1,darkMode:!1,autoUpdate:!0,updateInterval:3e5,cloudSync:{enabled:!1}},metadata:{createdAt:new Date().toISOString(),lastModified:new Date().toISOString()}}}generateId(){return`account_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}validateAccountName(t){if(!t||t.trim().length===0)throw new c("帳戶名稱不能為空","name");if(t.trim().length>50)throw new c("帳戶名稱不能超過 50 個字元","name")}createAccount(t){this.validateAccountName(t);const e={id:this.generateId(),name:t.trim(),createdAt:new Date().toISOString()};return this.accounts.set(e.id,e),this.saveAccounts(),e}updateAccount(t,e){const o=this.accounts.get(t);if(!o)throw new c(`找不到帳戶 ID: ${t}`,"accountId");return this.validateAccountName(e),o.name=e.trim(),this.accounts.set(t,o),this.saveAccounts(),o}deleteAccount(t){if(!this.accounts.has(t))throw new c(`找不到帳戶 ID: ${t}`,"accountId");this.accounts.delete(t),this.saveAccounts()}getAccount(t){return this.accounts.get(t)}getAllAccounts(){return Array.from(this.accounts.values())}hasAccount(t){return this.accounts.has(t)}getAccountCount(){return this.accounts.size}}class V{constructor(t){f(this,"dividends",new Map);this.storageService=t,this.loadFromStorage()}loadFromStorage(){try{const t=this.storageService.load();if(t&&t.dividends){for(const e of t.dividends)this.dividends.set(e.id,e);console.log(`已載入 ${this.dividends.size} 筆股息資料`)}else console.log("無現有股息資料，從空白狀態開始")}catch(t){console.error("載入股息資料失敗:",t),this.dividends.clear()}}saveToStorage(){try{const t=this.storageService.load()||this.createEmptyPortfolioData();t.dividends=Array.from(this.dividends.values()),this.storageService.save(t),console.log(`已儲存 ${this.dividends.size} 筆股息資料`)}catch(t){throw console.error("儲存股息資料失敗:",t),new S("儲存股息資料失敗","STORAGE_ERROR")}}createEmptyPortfolioData(){return{version:"1.3.0",accounts:[],stocks:[],dividends:[],settings:{privacyMode:!1,darkMode:!1,autoUpdate:!1,updateInterval:3e5,cloudSync:{enabled:!1}},metadata:{createdAt:new Date().toISOString(),lastModified:new Date().toISOString()}}}generateDividendId(){return`dividend_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async addDividend(t){const{validateAmount:e,validateDate:o}=await D(async()=>{const{validateAmount:d,validateDate:s}=await import("./validators._HnbLAi4.js");return{validateAmount:d,validateDate:s}},[],import.meta.url),a=e(t.dividendPerShare);if(!a.valid)throw new c(a.error||"每股股息金額格式錯誤","dividendPerShare");const i=e(t.totalDividend);if(!i.valid)throw new c(i.error||"總股息金額格式錯誤","totalDividend");const n=o(t.exDividendDate,{allowFuture:!0});if(!n.valid)throw new c(n.error||"除息日期格式錯誤","exDividendDate");if(!t.stockId||t.stockId.trim()==="")throw new c("股票 ID 不能為空","stockId");const r={id:this.generateDividendId(),stockId:t.stockId,exDividendDate:new Date(t.exDividendDate).toISOString(),dividendPerShare:t.dividendPerShare,totalDividend:t.totalDividend,createdAt:new Date().toISOString()};return this.dividends.set(r.id,r),this.saveToStorage(),console.log(`✅ 新增股息記錄成功: 股票 ${r.stockId}, 每股 ${r.dividendPerShare}, 總計 ${r.totalDividend}`),r}async updateDividend(t,e){const o=this.dividends.get(t);if(!o)throw new S(`股息記錄不存在: ${t}`,"DIVIDEND_NOT_FOUND");const{validateAmount:a,validateDate:i}=await D(async()=>{const{validateAmount:r,validateDate:d}=await import("./validators._HnbLAi4.js");return{validateAmount:r,validateDate:d}},[],import.meta.url);if(e.dividendPerShare!==void 0){const r=a(e.dividendPerShare);if(!r.valid)throw new c(r.error||"每股股息金額格式錯誤","dividendPerShare")}if(e.totalDividend!==void 0){const r=a(e.totalDividend);if(!r.valid)throw new c(r.error||"總股息金額格式錯誤","totalDividend")}if(e.exDividendDate!==void 0){const r=i(e.exDividendDate,{allowFuture:!0});if(!r.valid)throw new c(r.error||"除息日期格式錯誤","exDividendDate")}if(e.stockId!==void 0&&e.stockId.trim()==="")throw new c("股票 ID 不能為空","stockId");const n={...o,...e,exDividendDate:e.exDividendDate?new Date(e.exDividendDate).toISOString():o.exDividendDate};return this.dividends.set(t,n),this.saveToStorage(),console.log(`✅ 更新股息記錄成功: ${t}`),n}deleteDividend(t){if(!this.dividends.get(t))throw new S(`股息記錄不存在: ${t}`,"DIVIDEND_NOT_FOUND");this.dividends.delete(t),this.saveToStorage(),console.log(`✅ 刪除股息記錄成功: ${t}`)}getDividendsByStock(t){return Array.from(this.dividends.values()).filter(o=>o.stockId===t).sort((o,a)=>new Date(a.exDividendDate).getTime()-new Date(o.exDividendDate).getTime())}calculateAdjustedCostPrice(t,e,o){const i=this.getDividendsByStock(t).reduce((r,d)=>r+d.totalDividend,0);return i===0||o===0?e:e-i/o}calculateTotalDividend(t){let e;return t?e=this.getDividendsByStock(t):e=Array.from(this.dividends.values()),e.reduce((a,i)=>a+i.totalDividend,0)}getAllDividends(){return Array.from(this.dividends.values())}getDividend(t){return this.dividends.get(t)||null}}function _(l,t,e){return typeof l!="number"||typeof t!="number"||typeof e!="number"||isNaN(l)||isNaN(t)||isNaN(e)?0:(l-t)*e}class C{constructor(t,e,o){this.stockManager=t,this.accountManager=e,this.dividendManager=o}calculateStats(t){let e=0,o=0,a=0,i=0;for(const s of t){const g=s.currentPrice*s.shares,v=s.costPrice*s.shares,w=_(s.currentPrice,s.costPrice,s.shares),u=this.dividendManager.calculateTotalDividend(s.id);e+=g,o+=v,a+=w,i+=u}const n=o>0?a/o*100:0,r=a+i,d=o>0?r/o*100:0;return{totalValue:e,totalCost:o,totalGain:a,totalGainPercent:n,totalDividend:i,totalReturn:r,totalReturnPercent:d}}getAccountStats(t){const e=this.accountManager.getAccount(t);if(!e)throw new Error(`帳戶不存在: ${t}`);const o=this.stockManager.getStocksByAccount(t),a=this.calculateStats(o);return console.log(`計算帳戶統計: ${e.name} - 總市值 ${a.totalValue}, 總報酬率 ${a.totalReturnPercent.toFixed(2)}%`),a}getTotalStats(){const t=this.stockManager.getAllStocks(),e=this.calculateStats(t);return console.log(`計算總體統計: 總市值 ${e.totalValue}, 總報酬率 ${e.totalReturnPercent.toFixed(2)}%`),e}calculatePortfolioStats(t){return t?this.getAccountStats(t):this.getTotalStats()}getAllAccountStats(){return this.accountManager.getAllAccounts().map(e=>({accountId:e.id,accountName:e.name,stats:this.getAccountStats(e.id)}))}getPortfolioSummary(){const t=this.getTotalStats(),e=this.getAllAccountStats(),o=this.stockManager.getAllStocks().length,a=this.accountManager.getAccountCount();return{totalStats:t,accountStats:e,stockCount:o,accountCount:a}}}export{A,V as D,C as P,P as S,R as a,M as b};
//# sourceMappingURL=managers.DxU0Vghc.js.map
