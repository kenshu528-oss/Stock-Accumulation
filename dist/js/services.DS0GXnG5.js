var f=Object.defineProperty;var d=(l,t,e)=>t in l?f(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var m=(l,t,e)=>d(l,typeof t!="symbol"?t+"":t,e);import{S as c,A as s}from"./managers.DxU0Vghc.js";class T{constructor(){m(this,"STORAGE_KEY","stockPortfolio_v1.3")}save(t){try{t.metadata.lastModified=new Date().toISOString();const e=JSON.stringify(t);localStorage.setItem(this.STORAGE_KEY,e)}catch(e){throw e.name==="QuotaExceededError"?new c("儲存空間不足，請清理瀏覽器資料或匯出備份"):new c(`儲存資料失敗: ${e.message}`)}}load(){try{const t=localStorage.getItem(this.STORAGE_KEY);return t?JSON.parse(t):null}catch(t){throw console.error("資料解析失敗:",t),new c(`載入資料失敗: ${t.message}`)}}clear(){localStorage.removeItem(this.STORAGE_KEY)}hasData(){return localStorage.getItem(this.STORAGE_KEY)!==null}getStorageKey(){return this.STORAGE_KEY}}class A{constructor(){m(this,"OLD_STORAGE_KEY","stockPortfolio_v1.2");m(this,"NEW_STORAGE_KEY","stockPortfolio_v1.3")}hasOldData(){return localStorage.getItem(this.OLD_STORAGE_KEY)!==null}hasNewData(){return localStorage.getItem(this.NEW_STORAGE_KEY)!==null}shouldPromptMigration(){return this.hasOldData()&&!this.hasNewData()}migrate(){try{const t=this.loadOldData();if(!t)throw new c("無法讀取舊版資料");const e=this.transformData(t);return this.validateNewData(e),localStorage.setItem(this.NEW_STORAGE_KEY,JSON.stringify(e)),console.log("✅ 資料遷移成功",{stocks:e.stocks.length,accounts:e.accounts.length,from:this.OLD_STORAGE_KEY,to:this.NEW_STORAGE_KEY}),{success:!0,migratedStocks:e.stocks.length,migratedAccounts:e.accounts.length}}catch(t){console.error("❌ 資料遷移失敗:",t);try{localStorage.removeItem(this.NEW_STORAGE_KEY)}catch(e){console.error("回滾失敗:",e)}return{success:!1,error:t.message||"未知錯誤"}}}loadOldData(){try{const t=localStorage.getItem(this.OLD_STORAGE_KEY);return t?JSON.parse(t):null}catch(t){throw new c(`解析舊版資料失敗: ${t.message}`)}}transformData(t){const e=new Date().toISOString(),o=new Map,a=[];if(t.accounts&&t.accounts.length>0)t.accounts.forEach(n=>{const u=this.generateUUID();o.set(n,u),a.push({id:u,name:n,createdAt:e})});else{const n=this.generateUUID();o.set("預設帳戶",n),a.push({id:n,name:"預設帳戶",createdAt:e})}const r=[],i=[];return t.stocks&&t.stocks.length>0&&t.stocks.forEach(n=>{const u=o.get(n.account)||a[0].id,g=this.generateUUID(),w={id:g,code:n.stockCode,name:n.stockName,shares:n.quantity,costPrice:n.buyPrice,currentPrice:n.currentPrice||n.buyPrice,purchaseDate:this.convertDateToISO(n.buyDate),accountId:u,lastUpdated:e,dataSource:"Local"};r.push(w),n.dividends&&Array.isArray(n.dividends)&&n.dividends.forEach(p=>{const y={id:this.generateUUID(),stockId:g,exDividendDate:this.convertDateToISO(p.date),dividendPerShare:p.amount,totalDividend:p.amount*(p.shares||n.quantity),createdAt:e};i.push(y)})}),{version:"1.3.0",accounts:a,stocks:r,dividends:i,settings:{privacyMode:!1,darkMode:!1,autoUpdate:!0,updateInterval:3e5,cloudSync:{enabled:!1}},metadata:{createdAt:e,lastModified:e,migratedFrom:"v1.2.X"}}}validateNewData(t){if(!t.version)throw new c("遷移資料缺少版本號");if(!Array.isArray(t.accounts))throw new c("遷移資料的帳戶格式不正確");if(!Array.isArray(t.stocks))throw new c("遷移資料的股票格式不正確");if(!Array.isArray(t.dividends))throw new c("遷移資料的股息格式不正確");t.stocks.forEach((e,o)=>{if(!e.id||!e.code||!e.name)throw new c(`股票 ${o+1} 缺少必要欄位`);if(typeof e.shares!="number"||e.shares<=0)throw new c(`股票 ${e.code} 的持股數無效`);if(typeof e.costPrice!="number"||e.costPrice<=0)throw new c(`股票 ${e.code} 的成本價無效`);if(!t.accounts.some(r=>r.id===e.accountId))throw new c(`股票 ${e.code} 的帳戶 ID 不存在`)}),t.accounts.forEach((e,o)=>{if(!e.id||!e.name)throw new c(`帳戶 ${o+1} 缺少必要欄位`)}),t.dividends.forEach((e,o)=>{if(!e.id||!e.stockId)throw new c(`股息記錄 ${o+1} 缺少必要欄位`);if(!t.stocks.some(r=>r.id===e.stockId))throw new c(`股息記錄 ${o+1} 的股票 ID 不存在`)}),console.log("✅ 資料驗證通過")}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}convertDateToISO(t){if(!t)return new Date().toISOString();try{const e=new Date(t);return isNaN(e.getTime())?(console.warn(`無效的日期格式: ${t}，使用當前時間`),new Date().toISOString()):e.toISOString()}catch{return console.warn(`日期轉換失敗: ${t}，使用當前時間`),new Date().toISOString()}}}class I{constructor(){m(this,"cache",new Map);m(this,"CACHE_TTL",6e4);m(this,"localDB",new Map);m(this,"API_TIMEOUT",1e4);this.loadLocalDatabase()}isCacheValid(t){const e=this.cache.get(t);return e?Date.now()-e.cachedAt<this.CACHE_TTL:!1}updateCache(t,e){const o={data:e,cachedAt:Date.now()};this.cache.set(t,o)}clearCache(t){this.cache.delete(t)}clearAllCache(){this.cache.clear()}loadLocalDatabase(){const t=[{code:"2330",name:"台積電",type:"上市"},{code:"2317",name:"鴻海",type:"上市"},{code:"2454",name:"聯發科",type:"上市"},{code:"2308",name:"台達電",type:"上市"},{code:"2303",name:"聯電",type:"上市"},{code:"2412",name:"中華電",type:"上市"},{code:"3008",name:"大立光",type:"上市"},{code:"2002",name:"中鋼",type:"上市"},{code:"1301",name:"台塑",type:"上市"},{code:"1303",name:"南亞",type:"上市"},{code:"1326",name:"台化",type:"上市"},{code:"2882",name:"國泰金",type:"上市"},{code:"2881",name:"富邦金",type:"上市"},{code:"2886",name:"兆豐金",type:"上市"},{code:"2891",name:"中信金",type:"上市"},{code:"2892",name:"第一金",type:"上市"},{code:"2884",name:"玉山金",type:"上市"},{code:"2885",name:"元大金",type:"上市"},{code:"2887",name:"台新金",type:"上市"},{code:"2890",name:"永豐金",type:"上市"},{code:"2883",name:"開發金",type:"上市"},{code:"1216",name:"統一",type:"上市"},{code:"1101",name:"台泥",type:"上市"},{code:"2207",name:"和泰車",type:"上市"},{code:"2382",name:"廣達",type:"上市"},{code:"2357",name:"華碩",type:"上市"},{code:"2301",name:"光寶科",type:"上市"},{code:"2409",name:"友達",type:"上市"},{code:"3045",name:"台灣大",type:"上市"},{code:"4904",name:"遠傳",type:"上市"},{code:"0050",name:"元大台灣50",type:"ETF"},{code:"0056",name:"元大高股息",type:"ETF"},{code:"00878",name:"國泰永續高股息",type:"ETF"},{code:"00881",name:"國泰台灣5G+",type:"ETF"},{code:"00900",name:"富邦特選高股息30",type:"ETF"},{code:"00919",name:"群益台灣精選高息",type:"ETF"},{code:"00929",name:"復華台灣科技優息",type:"ETF"},{code:"00631L",name:"元大台灣50正2",type:"ETF"},{code:"00632R",name:"元大台灣50反1",type:"ETF"},{code:"00757",name:"統一FANG+",type:"ETF"},{code:"00830",name:"國泰費城半導體",type:"ETF"},{code:"00850",name:"元大臺灣ESG永續",type:"ETF"},{code:"00692",name:"富邦公司治理",type:"ETF"},{code:"00701",name:"國泰股利精選30",type:"ETF"},{code:"00713",name:"元大台灣高息低波",type:"ETF"},{code:"5274",name:"信驊",type:"上櫃"},{code:"6446",name:"藥華藥",type:"上櫃"},{code:"4968",name:"立積",type:"上櫃"},{code:"6488",name:"環球晶",type:"上櫃"},{code:"5269",name:"祥碩",type:"上櫃"},{code:"3443",name:"創意",type:"上櫃"},{code:"6415",name:"矽力-KY",type:"上櫃"},{code:"4919",name:"新唐",type:"上櫃"},{code:"6669",name:"緯穎",type:"上櫃"},{code:"3711",name:"日月光投控",type:"上櫃"}];for(const e of t)this.localDB.set(e.code,e);console.log(`本地資料庫已載入 ${this.localDB.size} 筆股票資料`)}getFromLocalDB(t){const e=this.localDB.get(t);return e?(console.log(`本地資料庫找到股票: ${t} - ${e.name}`),null):(console.log(`本地資料庫找不到股票: ${t}`),null)}getStockInfoFromLocalDB(t){const e=this.localDB.get(t);return e?{code:e.code,name:e.name,type:e.type,source:"Local"}:null}async getStockPrice(t){if(this.isCacheValid(t))return console.log(`使用快取資料: ${t}`),this.cache.get(t).data;try{console.log(`[1/3] 嘗試證交所 API: ${t}`);const o=await this.fetchFromTWSE(t),a={price:o,source:"TWSE",timestamp:new Date().toISOString()};return this.updateCache(t,a),console.log(`✅ 證交所 API 成功: ${t} = ${o}`),a}catch(o){console.warn(`❌ 證交所 API 失敗: ${o instanceof Error?o.message:String(o)}`)}try{console.log(`[2/3] 嘗試 Yahoo Finance API: ${t}`);const o=await this.fetchFromYahoo(t),a={price:o,source:"Yahoo",timestamp:new Date().toISOString()};return this.updateCache(t,a),console.log(`✅ Yahoo Finance API 成功: ${t} = ${o}`),a}catch(o){console.warn(`❌ Yahoo Finance API 失敗: ${o instanceof Error?o.message:String(o)}`)}console.log(`[3/3] 嘗試本地資料庫: ${t}`);const e=this.getFromLocalDB(t);if(e!==null){const o={price:e,source:"Local",timestamp:new Date().toISOString()};return console.log(`✅ 本地資料庫成功: ${t} = ${e}`),o}throw console.error(`❌ 所有 API 都無法取得股票 ${t} 的價格`),new s(`無法取得股票 ${t} 的價格，所有資料來源都失敗`)}async searchStockByCode(t){try{console.log(`[1/3] 嘗試證交所 API 搜尋: ${t}`);const o=await this.fetchFromTWSE(t),a=this.getStockInfoFromLocalDB(t),r={code:t,name:(a==null?void 0:a.name)||t,price:o,type:a==null?void 0:a.type,source:"TWSE"};return console.log(`✅ 證交所 API 搜尋成功: ${t}`),r}catch(o){console.warn(`❌ 證交所 API 搜尋失敗: ${o instanceof Error?o.message:String(o)}`)}try{console.log(`[2/3] 嘗試 Yahoo Finance API 搜尋: ${t}`);const o=await this.fetchFromYahoo(t),a=this.getStockInfoFromLocalDB(t),r={code:t,name:(a==null?void 0:a.name)||t,price:o,type:a==null?void 0:a.type,source:"Yahoo"};return console.log(`✅ Yahoo Finance API 搜尋成功: ${t}`),r}catch(o){console.warn(`❌ Yahoo Finance API 搜尋失敗: ${o instanceof Error?o.message:String(o)}`)}console.log(`[3/3] 嘗試本地資料庫搜尋: ${t}`);const e=this.getStockInfoFromLocalDB(t);if(e)return console.log(`✅ 本地資料庫搜尋成功: ${t}`),e;throw console.error(`❌ 所有 API 都無法找到股票 ${t} 的資訊`),new s(`無法找到股票 ${t} 的資訊，所有資料來源都失敗`)}async fetchFromTWSE(t){console.log(`證交所 API 查詢: ${t}`);const e=this.getStockType(t);console.log(`股票類型: ${e}`);try{switch(e){case"listed":return await this.fetchFromTWSEListed(t);case"otc":return await this.fetchFromTPEx(t);case"emerging":return await this.fetchFromEmerging(t);case"etf":return await this.fetchFromETF(t);default:return await this.fetchFromAllTWSE(t)}}catch(o){throw console.warn(`證交所 API 查詢失敗: ${o instanceof Error?o.message:String(o)}`),new s(`證交所 API 查詢失敗: ${o instanceof Error?o.message:String(o)}`)}}getStockType(t){return/^00\d+/.test(t)?"etf":/^[1-9]\d{3}$/.test(t)?"listed":/^[4-8]\d{3}$/.test(t)?"otc":"unknown"}async fetchFromTWSEListed(t){const e=new Date,a=`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${e.getFullYear()+String(e.getMonth()+1).padStart(2,"0")+String(e.getDate()).padStart(2,"0")}&stockNo=${t}`,r=await this.fetchWithTimeout(a,this.API_TIMEOUT);if(!r.ok)throw new s(`TWSE API 錯誤: ${r.status}`,r.status);const i=await r.json();if(i.stat!=="OK"||!i.data||i.data.length===0)throw new s("TWSE 無資料或股票代碼錯誤");const h=i.data[i.data.length-1],n=parseFloat(h[6].replace(/,/g,""));if(isNaN(n)||n<=0)throw new s("無效的價格資料");return n}async fetchFromTPEx(t){const e=new Date,a=`https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?l=zh-tw&d=${e.getFullYear()+"/"+String(e.getMonth()+1).padStart(2,"0")+"/"+String(e.getDate()).padStart(2,"0")}&stkno=${t}`,r=await this.fetchWithTimeout(a,this.API_TIMEOUT);if(!r.ok)throw new s(`TPEx API 錯誤: ${r.status}`,r.status);const i=await r.json();if(!i.aaData||i.aaData.length===0)throw new s("TPEx 無資料或股票代碼錯誤");const h=i.aaData[0],n=parseFloat(h[2]);if(isNaN(n)||n<=0)throw new s("無效的價格資料");return n}async fetchFromEmerging(t){try{return await this.fetchFromTPEx(t)}catch(e){throw new s(`興櫃股票查詢失敗: ${e instanceof Error?e.message:String(e)}`)}}async fetchFromETF(t){try{return await this.fetchFromTWSEListed(t)}catch{return await this.fetchFromTPEx(t)}}async fetchFromAllTWSE(t){const e=[{name:"上市",method:()=>this.fetchFromTWSEListed(t)},{name:"上櫃",method:()=>this.fetchFromTPEx(t)},{name:"興櫃",method:()=>this.fetchFromEmerging(t)}];for(const o of e)try{console.log(`嘗試 ${o.name} API: ${t}`);const a=await o.method();if(a>0)return console.log(`✅ ${o.name} API 成功: ${t}`),a}catch(a){console.warn(`❌ ${o.name} API 失敗: ${a instanceof Error?a.message:String(a)}`);continue}throw new s("所有證交所 API 都無法找到此股票")}async fetchWithTimeout(t,e){const o=new AbortController,a=setTimeout(()=>o.abort(),e);try{const r=await fetch(t,{signal:o.signal});return clearTimeout(a),r}catch(r){throw clearTimeout(a),r instanceof Error&&r.name==="AbortError"?new s("請求逾時"):new s(`請求失敗: ${r instanceof Error?r.message:String(r)}`)}}async fetchFromYahoo(t){var r,i;const e=this.formatTaiwanSymbol(t),o="https://api.allorigins.win/raw?url=",a=`https://query1.finance.yahoo.com/v8/finance/chart/${e}`;try{const h=await this.fetchWithTimeout(o+encodeURIComponent(a),this.API_TIMEOUT);if(!h.ok)throw new s(`Yahoo Finance API 錯誤: HTTP ${h.status}`,h.status);const u=(i=(r=(await h.json()).chart)==null?void 0:r.result)==null?void 0:i[0];if(!u)throw new s("Yahoo Finance 回應格式無效");const g=u.meta,w=g.regularMarketPrice||g.previousClose;if(!w||w<=0)throw new s("無法從 Yahoo Finance 取得有效價格");return w}catch(h){throw h instanceof s?h:new s(`Yahoo Finance API 呼叫失敗: ${h instanceof Error?h.message:String(h)}`)}}formatTaiwanSymbol(t){return/^\d{4,6}$/.test(t)?`${t}.TW`:`${t}.TW`}}export{A as M,T as S,I as a};
//# sourceMappingURL=services.DS0GXnG5.js.map
