{"version":3,"mappings":"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","names":["StockError","message","code","details","__publicField","ApiError","statusCode","ValidationError","field","StorageError","StockManager","apiService","storageService","data","stock","error","stockData","validateStockCode","validateAmount","validateShares","validateDate","__vitePreload","codeValidation","sharesValidation","costPriceValidation","currentPriceValidation","dateValidation","stockName","dataSource","stockInfo","newStock","stockId","updates","updatedStock","accountId","priceResult","allStocks","total","results","success","failed","detailedResults","result","index","AccountManager","account","name","newName","DividendManager","dividend","dividendData","dividendPerShareValidation","totalDividendValidation","newDividend","dividendId","validation","updatedDividend","a","b","originalCostPrice","currentShares","totalDividendIncome","sum","dividendsToSum","calculateGain","currentPrice","costPrice","shares","PortfolioManager","stockManager","accountManager","dividendManager","stocks","totalValue","totalCost","totalGain","totalDividend","stockValue","stockCost","stockGain","stockDividend","totalGainPercent","totalReturn","totalReturnPercent","accountStocks","stats","totalStats","accountStats","stockCount","accountCount"],"ignoreList":[],"sources":["../../src/types/Errors.ts","../../src/managers/StockManager.ts","../../src/managers/AccountManager.ts","../../src/managers/DividendManager.ts","../../src/utils/calculators.ts","../../src/managers/PortfolioManager.ts"],"sourcesContent":["/**\r\n * Error type definitions for v1.3.X architecture\r\n * Custom error classes for different error scenarios\r\n */\r\n\r\n/**\r\n * Base error class for stock portfolio system\r\n */\r\nexport class StockError extends Error {\r\n  /** Error code for categorization */\r\n  public code: string;\r\n  \r\n  /** Additional error details */\r\n  public details?: any;\r\n  \r\n  constructor(message: string, code: string, details?: any) {\r\n    super(message);\r\n    this.name = 'StockError';\r\n    this.code = code;\r\n    this.details = details;\r\n    \r\n    // Maintains proper stack trace for where error was thrown (V8 only)\r\n    if (Error.captureStackTrace) {\r\n      Error.captureStackTrace(this, StockError);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Error class for API-related errors\r\n * Used when external API calls fail\r\n */\r\nexport class ApiError extends StockError {\r\n  /** HTTP status code (if applicable) */\r\n  public statusCode?: number;\r\n  \r\n  constructor(message: string, statusCode?: number) {\r\n    super(message, 'API_ERROR');\r\n    this.name = 'ApiError';\r\n    this.statusCode = statusCode;\r\n    \r\n    if (Error.captureStackTrace) {\r\n      Error.captureStackTrace(this, ApiError);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Error class for validation errors\r\n * Used when user input or data validation fails\r\n */\r\nexport class ValidationError extends StockError {\r\n  /** Field name that failed validation */\r\n  public field: string;\r\n  \r\n  constructor(message: string, field: string) {\r\n    super(message, 'VALIDATION_ERROR');\r\n    this.name = 'ValidationError';\r\n    this.field = field;\r\n    \r\n    if (Error.captureStackTrace) {\r\n      Error.captureStackTrace(this, ValidationError);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Error class for storage-related errors\r\n * Used when LocalStorage or cloud sync operations fail\r\n */\r\nexport class StorageError extends StockError {\r\n  constructor(message: string) {\r\n    super(message, 'STORAGE_ERROR');\r\n    this.name = 'StorageError';\r\n    \r\n    if (Error.captureStackTrace) {\r\n      Error.captureStackTrace(this, StorageError);\r\n    }\r\n  }\r\n}\r\n","/**\r\n * StockManager - 股票管理器\r\n * \r\n * 負責管理所有股票相關的業務邏輯：\r\n * - 股票的 CRUD 操作（新增、讀取、更新、刪除）\r\n * - 股價更新（單一股票和批次更新）\r\n * - 股票查詢和篩選\r\n * \r\n * 依賴注入：\r\n * - StockApiService: 用於取得股價資料\r\n * - StorageService: 用於持久化儲存\r\n */\r\n\r\nimport { Stock } from '../types/Stock';\r\nimport { PortfolioData } from '../types/Portfolio';\r\nimport { StockApiService } from '../services/StockApiService';\r\nimport { StorageService } from '../services/StorageService';\r\nimport { ValidationError, StockError } from '../types/Errors';\r\n\r\n/**\r\n * 股票管理器類別\r\n * 封裝所有股票相關的業務邏輯\r\n */\r\nexport class StockManager {\r\n  /** 股票資料儲存 - 使用 Map 結構以股票 ID 為鍵值 */\r\n  private stocks: Map<string, Stock> = new Map();\r\n  \r\n  /**\r\n   * 建構函數 - 使用依賴注入模式\r\n   * @param apiService - 股價 API 服務實例\r\n   * @param storageService - 儲存服務實例\r\n   */\r\n  constructor(\r\n    private apiService: StockApiService,\r\n    private storageService: StorageService\r\n  ) {\r\n    // 初始化時從儲存載入現有資料\r\n    this.loadFromStorage();\r\n  }\r\n  \r\n  /**\r\n   * 從儲存服務載入股票資料\r\n   * 在初始化時自動呼叫\r\n   * @private\r\n   */\r\n  private loadFromStorage(): void {\r\n    try {\r\n      const data = this.storageService.load();\r\n      \r\n      if (data && data.stocks) {\r\n        // 將股票陣列轉換為 Map 結構\r\n        for (const stock of data.stocks) {\r\n          this.stocks.set(stock.id, stock);\r\n        }\r\n        \r\n        console.log(`已載入 ${this.stocks.size} 筆股票資料`);\r\n      } else {\r\n        console.log('無現有股票資料，從空白狀態開始');\r\n      }\r\n    } catch (error) {\r\n      console.error('載入股票資料失敗:', error);\r\n      // 載入失敗時從空白狀態開始\r\n      this.stocks.clear();\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * 儲存股票資料到儲存服務\r\n   * 在每次修改後自動呼叫\r\n   * @private\r\n   */\r\n  private saveToStorage(): void {\r\n    try {\r\n      // 載入完整的投資組合資料\r\n      const data = this.storageService.load() || this.createEmptyPortfolioData();\r\n      \r\n      // 更新股票陣列\r\n      data.stocks = Array.from(this.stocks.values());\r\n      \r\n      // 儲存回儲存服務\r\n      this.storageService.save(data);\r\n      \r\n      console.log(`已儲存 ${this.stocks.size} 筆股票資料`);\r\n    } catch (error) {\r\n      console.error('儲存股票資料失敗:', error);\r\n      throw new StockError('儲存股票資料失敗', 'STORAGE_ERROR');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * 建立空的投資組合資料結構\r\n   * 用於初始化或重置\r\n   * @private\r\n   * @returns 空的投資組合資料\r\n   */\r\n  private createEmptyPortfolioData(): PortfolioData {\r\n    return {\r\n      version: '1.3.0',\r\n      accounts: [],\r\n      stocks: [],\r\n      dividends: [],\r\n      settings: {\r\n        privacyMode: false,\r\n        darkMode: false,\r\n        autoUpdate: false,\r\n        updateInterval: 300000, // 5 分鐘\r\n        cloudSync: {\r\n          enabled: false\r\n        }\r\n      },\r\n      metadata: {\r\n        createdAt: new Date().toISOString(),\r\n        lastModified: new Date().toISOString()\r\n      }\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * 產生唯一的股票 ID\r\n   * 使用時間戳記和隨機數組合\r\n   * @private\r\n   * @returns 唯一的股票 ID\r\n   */\r\n  private generateStockId(): string {\r\n    return `stock_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n  \r\n  /**\r\n   * 新增股票\r\n   * 驗證輸入資料、查詢股票資訊（如果需要）、建立股票記錄\r\n   * \r\n   * @param stockData - 股票資料（不含 id 和 lastUpdated）\r\n   * @returns 新建立的股票記錄\r\n   * @throws {ValidationError} 當輸入資料驗證失敗時\r\n   * @throws {StockError} 當新增股票失敗時\r\n   */\r\n  async addStock(stockData: Omit<Stock, 'id' | 'lastUpdated'>): Promise<Stock> {\r\n    // 驗證股票代碼\r\n    const { validateStockCode, validateAmount, validateShares, validateDate } = await import('../utils/validators');\r\n    \r\n    const codeValidation = validateStockCode(stockData.code);\r\n    if (!codeValidation.valid) {\r\n      throw new ValidationError(codeValidation.error || '股票代碼格式錯誤', 'code');\r\n    }\r\n    \r\n    // 驗證持股數\r\n    const sharesValidation = validateShares(stockData.shares);\r\n    if (!sharesValidation.valid) {\r\n      throw new ValidationError(sharesValidation.error || '持股數格式錯誤', 'shares');\r\n    }\r\n    \r\n    // 驗證成本價\r\n    const costPriceValidation = validateAmount(stockData.costPrice);\r\n    if (!costPriceValidation.valid) {\r\n      throw new ValidationError(costPriceValidation.error || '成本價格式錯誤', 'costPrice');\r\n    }\r\n    \r\n    // 驗證現價\r\n    const currentPriceValidation = validateAmount(stockData.currentPrice, true);\r\n    if (!currentPriceValidation.valid) {\r\n      throw new ValidationError(currentPriceValidation.error || '現價格式錯誤', 'currentPrice');\r\n    }\r\n    \r\n    // 驗證購買日期\r\n    const dateValidation = validateDate(stockData.purchaseDate, { allowFuture: false });\r\n    if (!dateValidation.valid) {\r\n      throw new ValidationError(dateValidation.error || '購買日期格式錯誤', 'purchaseDate');\r\n    }\r\n    \r\n    // 如果沒有提供股票名稱，嘗試從 API 查詢\r\n    let stockName = stockData.name;\r\n    let dataSource = stockData.dataSource;\r\n    \r\n    if (!stockName || stockName.trim() === '' || stockName === stockData.code) {\r\n      try {\r\n        console.log(`查詢股票名稱: ${stockData.code}`);\r\n        const stockInfo = await this.apiService.searchStockByCode(stockData.code);\r\n        stockName = stockInfo.name;\r\n        dataSource = stockInfo.source;\r\n        console.log(`✅ 找到股票名稱: ${stockName}`);\r\n      } catch (error) {\r\n        console.warn(`無法查詢股票名稱，使用股票代碼: ${error instanceof Error ? error.message : String(error)}`);\r\n        stockName = stockData.code;\r\n      }\r\n    }\r\n    \r\n    // 建立新股票記錄\r\n    const newStock: Stock = {\r\n      id: this.generateStockId(),\r\n      code: stockData.code.trim().toUpperCase(),\r\n      name: stockName,\r\n      shares: stockData.shares,\r\n      costPrice: stockData.costPrice,\r\n      currentPrice: stockData.currentPrice,\r\n      purchaseDate: new Date(stockData.purchaseDate).toISOString(),\r\n      accountId: stockData.accountId,\r\n      lastUpdated: new Date().toISOString(),\r\n      dataSource: dataSource\r\n    };\r\n    \r\n    // 儲存到 Map\r\n    this.stocks.set(newStock.id, newStock);\r\n    \r\n    // 持久化儲存\r\n    this.saveToStorage();\r\n    \r\n    console.log(`✅ 新增股票成功: ${newStock.code} - ${newStock.name}`);\r\n    \r\n    return newStock;\r\n  }\r\n  \r\n  /**\r\n   * 更新股票資訊\r\n   * 可以更新股票的任何欄位（除了 id）\r\n   * \r\n   * @param stockId - 股票 ID\r\n   * @param updates - 要更新的欄位\r\n   * @returns 更新後的股票記錄\r\n   * @throws {StockError} 當股票不存在或更新失敗時\r\n   * @throws {ValidationError} 當更新資料驗證失敗時\r\n   */\r\n  async updateStock(stockId: string, updates: Partial<Omit<Stock, 'id'>>): Promise<Stock> {\r\n    // 檢查股票是否存在\r\n    const stock = this.stocks.get(stockId);\r\n    if (!stock) {\r\n      throw new StockError(`股票不存在: ${stockId}`, 'STOCK_NOT_FOUND');\r\n    }\r\n    \r\n    // 驗證更新資料\r\n    const { validateStockCode, validateAmount, validateShares, validateDate } = await import('../utils/validators');\r\n    \r\n    if (updates.code !== undefined) {\r\n      const codeValidation = validateStockCode(updates.code);\r\n      if (!codeValidation.valid) {\r\n        throw new ValidationError(codeValidation.error || '股票代碼格式錯誤', 'code');\r\n      }\r\n    }\r\n    \r\n    if (updates.shares !== undefined) {\r\n      const sharesValidation = validateShares(updates.shares);\r\n      if (!sharesValidation.valid) {\r\n        throw new ValidationError(sharesValidation.error || '持股數格式錯誤', 'shares');\r\n      }\r\n    }\r\n    \r\n    if (updates.costPrice !== undefined) {\r\n      const costPriceValidation = validateAmount(updates.costPrice);\r\n      if (!costPriceValidation.valid) {\r\n        throw new ValidationError(costPriceValidation.error || '成本價格式錯誤', 'costPrice');\r\n      }\r\n    }\r\n    \r\n    if (updates.currentPrice !== undefined) {\r\n      const currentPriceValidation = validateAmount(updates.currentPrice, true);\r\n      if (!currentPriceValidation.valid) {\r\n        throw new ValidationError(currentPriceValidation.error || '現價格式錯誤', 'currentPrice');\r\n      }\r\n    }\r\n    \r\n    if (updates.purchaseDate !== undefined) {\r\n      const dateValidation = validateDate(updates.purchaseDate, { allowFuture: false });\r\n      if (!dateValidation.valid) {\r\n        throw new ValidationError(dateValidation.error || '購買日期格式錯誤', 'purchaseDate');\r\n      }\r\n    }\r\n    \r\n    // 更新股票記錄\r\n    const updatedStock: Stock = {\r\n      ...stock,\r\n      ...updates,\r\n      lastUpdated: new Date().toISOString()\r\n    };\r\n    \r\n    // 儲存到 Map\r\n    this.stocks.set(stockId, updatedStock);\r\n    \r\n    // 持久化儲存\r\n    this.saveToStorage();\r\n    \r\n    console.log(`✅ 更新股票成功: ${updatedStock.code} - ${updatedStock.name}`);\r\n    \r\n    return updatedStock;\r\n  }\r\n  \r\n  /**\r\n   * 刪除股票\r\n   * 從系統中完全移除股票記錄\r\n   * \r\n   * @param stockId - 股票 ID\r\n   * @throws {StockError} 當股票不存在時\r\n   */\r\n  deleteStock(stockId: string): void {\r\n    // 檢查股票是否存在\r\n    const stock = this.stocks.get(stockId);\r\n    if (!stock) {\r\n      throw new StockError(`股票不存在: ${stockId}`, 'STOCK_NOT_FOUND');\r\n    }\r\n    \r\n    // 從 Map 中刪除\r\n    this.stocks.delete(stockId);\r\n    \r\n    // 持久化儲存\r\n    this.saveToStorage();\r\n    \r\n    console.log(`✅ 刪除股票成功: ${stock.code} - ${stock.name}`);\r\n  }\r\n  \r\n  /**\r\n   * 取得單一股票\r\n   * 根據股票 ID 查詢股票記錄\r\n   * \r\n   * @param stockId - 股票 ID\r\n   * @returns 股票記錄，如果不存在則返回 null\r\n   */\r\n  getStock(stockId: string): Stock | null {\r\n    return this.stocks.get(stockId) || null;\r\n  }\r\n  \r\n  /**\r\n   * 取得所有股票\r\n   * 返回系統中所有的股票記錄\r\n   * \r\n   * @returns 所有股票記錄的陣列\r\n   */\r\n  getAllStocks(): Stock[] {\r\n    return Array.from(this.stocks.values());\r\n  }\r\n  \r\n  /**\r\n   * 取得指定帳戶的股票\r\n   * 根據帳戶 ID 篩選股票記錄\r\n   * \r\n   * @param accountId - 帳戶 ID\r\n   * @returns 該帳戶的所有股票記錄\r\n   */\r\n  getStocksByAccount(accountId: string): Stock[] {\r\n    return Array.from(this.stocks.values()).filter(\r\n      stock => stock.accountId === accountId\r\n    );\r\n  }\r\n  \r\n  /**\r\n   * 更新單一股票股價\r\n   * 從 API 取得最新股價並更新股票記錄\r\n   * \r\n   * @param stockId - 股票 ID\r\n   * @returns 更新後的股票記錄\r\n   * @throws {StockError} 當股票不存在或更新失敗時\r\n   */\r\n  async updateStockPrice(stockId: string): Promise<Stock> {\r\n    // 檢查股票是否存在\r\n    const stock = this.stocks.get(stockId);\r\n    if (!stock) {\r\n      throw new StockError(`股票不存在: ${stockId}`, 'STOCK_NOT_FOUND');\r\n    }\r\n    \r\n    try {\r\n      console.log(`更新股價: ${stock.code} - ${stock.name}`);\r\n      \r\n      // 從 API 取得最新股價\r\n      const priceResult = await this.apiService.getStockPrice(stock.code);\r\n      \r\n      // 更新股票記錄\r\n      const updatedStock: Stock = {\r\n        ...stock,\r\n        currentPrice: priceResult.price,\r\n        dataSource: priceResult.source,\r\n        lastUpdated: new Date().toISOString()\r\n      };\r\n      \r\n      // 儲存到 Map\r\n      this.stocks.set(stockId, updatedStock);\r\n      \r\n      // 持久化儲存\r\n      this.saveToStorage();\r\n      \r\n      console.log(`✅ 股價更新成功: ${stock.code} = ${priceResult.price} (來源: ${priceResult.source})`);\r\n      \r\n      return updatedStock;\r\n    } catch (error) {\r\n      console.error(`❌ 股價更新失敗: ${stock.code}`, error);\r\n      throw new StockError(\r\n        `更新股價失敗: ${error instanceof Error ? error.message : String(error)}`,\r\n        'PRICE_UPDATE_FAILED'\r\n      );\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * 批次更新所有股價\r\n   * 使用 Promise.allSettled 處理部分失敗的情況\r\n   * 即使部分股票更新失敗，其他股票仍會繼續更新\r\n   * \r\n   * @returns 更新結果摘要\r\n   */\r\n  async updateAllPrices(): Promise<{\r\n    total: number;\r\n    success: number;\r\n    failed: number;\r\n    results: Array<{\r\n      stockId: string;\r\n      code: string;\r\n      name: string;\r\n      success: boolean;\r\n      price?: number;\r\n      error?: string;\r\n    }>;\r\n  }> {\r\n    const allStocks = Array.from(this.stocks.values());\r\n    const total = allStocks.length;\r\n    \r\n    console.log(`開始批次更新 ${total} 支股票的股價...`);\r\n    \r\n    // 使用 Promise.allSettled 處理所有更新請求\r\n    // 這樣即使部分失敗，其他股票仍會繼續更新\r\n    const results = await Promise.allSettled(\r\n      allStocks.map(stock => this.updateStockPrice(stock.id))\r\n    );\r\n    \r\n    // 統計結果\r\n    let success = 0;\r\n    let failed = 0;\r\n    const detailedResults: Array<{\r\n      stockId: string;\r\n      code: string;\r\n      name: string;\r\n      success: boolean;\r\n      price?: number;\r\n      error?: string;\r\n    }> = [];\r\n    \r\n    results.forEach((result, index) => {\r\n      const stock = allStocks[index];\r\n      \r\n      if (result.status === 'fulfilled') {\r\n        success++;\r\n        detailedResults.push({\r\n          stockId: stock.id,\r\n          code: stock.code,\r\n          name: stock.name,\r\n          success: true,\r\n          price: result.value.currentPrice\r\n        });\r\n      } else {\r\n        failed++;\r\n        detailedResults.push({\r\n          stockId: stock.id,\r\n          code: stock.code,\r\n          name: stock.name,\r\n          success: false,\r\n          error: result.reason instanceof Error ? result.reason.message : String(result.reason)\r\n        });\r\n      }\r\n    });\r\n    \r\n    console.log(`批次更新完成: 總計 ${total} 支，成功 ${success} 支，失敗 ${failed} 支`);\r\n    \r\n    return {\r\n      total,\r\n      success,\r\n      failed,\r\n      results: detailedResults\r\n    };\r\n  }\r\n}\r\n","/**\r\n * AccountManager for v1.3.X architecture\r\n * Manages account CRUD operations and account-related business logic\r\n * \r\n * Key features:\r\n * - Create, read, update, delete accounts\r\n * - Account validation\r\n * - Integration with StorageService for persistence\r\n * - Automatic data synchronization\r\n */\r\n\r\nimport { Account } from '../types/Account';\r\nimport { StorageService } from '../services/StorageService';\r\nimport { ValidationError } from '../types/Errors';\r\nimport { PortfolioData } from '../types/Portfolio';\r\n\r\n/**\r\n * Manager class for account operations\r\n * Handles all account-related business logic\r\n */\r\nexport class AccountManager {\r\n  /** In-memory map of accounts for fast access */\r\n  private accounts: Map<string, Account> = new Map();\r\n  \r\n  /**\r\n   * Constructor\r\n   * @param storageService - Storage service for data persistence\r\n   */\r\n  constructor(private storageService: StorageService) {\r\n    this.loadAccounts();\r\n  }\r\n  \r\n  /**\r\n   * Load accounts from storage into memory\r\n   * Called during initialization\r\n   */\r\n  private loadAccounts(): void {\r\n    const data = this.storageService.load();\r\n    if (data && data.accounts) {\r\n      data.accounts.forEach(account => {\r\n        this.accounts.set(account.id, account);\r\n      });\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Save current accounts to storage\r\n   * Updates the complete portfolio data\r\n   */\r\n  private saveAccounts(): void {\r\n    const data = this.storageService.load() || this.createEmptyPortfolioData();\r\n    data.accounts = Array.from(this.accounts.values());\r\n    this.storageService.save(data);\r\n  }\r\n  \r\n  /**\r\n   * Create empty portfolio data structure\r\n   * Used when no data exists in storage\r\n   */\r\n  private createEmptyPortfolioData(): PortfolioData {\r\n    return {\r\n      version: '1.3.0',\r\n      accounts: [],\r\n      stocks: [],\r\n      dividends: [],\r\n      settings: {\r\n        privacyMode: false,\r\n        darkMode: false,\r\n        autoUpdate: true,\r\n        updateInterval: 300000, // 5 minutes\r\n        cloudSync: {\r\n          enabled: false\r\n        }\r\n      },\r\n      metadata: {\r\n        createdAt: new Date().toISOString(),\r\n        lastModified: new Date().toISOString()\r\n      }\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * Generate a unique ID for an account\r\n   * Uses timestamp and random string for uniqueness\r\n   */\r\n  private generateId(): string {\r\n    return `account_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n  \r\n  /**\r\n   * Validate account name\r\n   * @param name - Account name to validate\r\n   * @throws {ValidationError} If name is invalid\r\n   */\r\n  private validateAccountName(name: string): void {\r\n    if (!name || name.trim().length === 0) {\r\n      throw new ValidationError('帳戶名稱不能為空', 'name');\r\n    }\r\n    \r\n    if (name.trim().length > 50) {\r\n      throw new ValidationError('帳戶名稱不能超過 50 個字元', 'name');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Create a new account\r\n   * @param name - Account name\r\n   * @returns The newly created account\r\n   * @throws {ValidationError} If name is invalid\r\n   */\r\n  createAccount(name: string): Account {\r\n    // Validate account name\r\n    this.validateAccountName(name);\r\n    \r\n    // Create new account\r\n    const account: Account = {\r\n      id: this.generateId(),\r\n      name: name.trim(),\r\n      createdAt: new Date().toISOString()\r\n    };\r\n    \r\n    // Add to in-memory map\r\n    this.accounts.set(account.id, account);\r\n    \r\n    // Persist to storage\r\n    this.saveAccounts();\r\n    \r\n    return account;\r\n  }\r\n  \r\n  /**\r\n   * Update an existing account's name\r\n   * @param accountId - ID of the account to update\r\n   * @param newName - New account name\r\n   * @returns The updated account\r\n   * @throws {ValidationError} If account not found or name is invalid\r\n   */\r\n  updateAccount(accountId: string, newName: string): Account {\r\n    // Check if account exists\r\n    const account = this.accounts.get(accountId);\r\n    if (!account) {\r\n      throw new ValidationError(`找不到帳戶 ID: ${accountId}`, 'accountId');\r\n    }\r\n    \r\n    // Validate new name\r\n    this.validateAccountName(newName);\r\n    \r\n    // Update account name\r\n    account.name = newName.trim();\r\n    \r\n    // Update in map\r\n    this.accounts.set(accountId, account);\r\n    \r\n    // Persist to storage\r\n    this.saveAccounts();\r\n    \r\n    return account;\r\n  }\r\n  \r\n  /**\r\n   * Delete an account\r\n   * Note: This does not delete associated stocks - caller should handle that\r\n   * @param accountId - ID of the account to delete\r\n   * @throws {ValidationError} If account not found\r\n   */\r\n  deleteAccount(accountId: string): void {\r\n    // Check if account exists\r\n    if (!this.accounts.has(accountId)) {\r\n      throw new ValidationError(`找不到帳戶 ID: ${accountId}`, 'accountId');\r\n    }\r\n    \r\n    // Remove from map\r\n    this.accounts.delete(accountId);\r\n    \r\n    // Persist to storage\r\n    this.saveAccounts();\r\n  }\r\n  \r\n  /**\r\n   * Get a single account by ID\r\n   * @param accountId - ID of the account to retrieve\r\n   * @returns The account if found, undefined otherwise\r\n   */\r\n  getAccount(accountId: string): Account | undefined {\r\n    return this.accounts.get(accountId);\r\n  }\r\n  \r\n  /**\r\n   * Get all accounts\r\n   * @returns Array of all accounts\r\n   */\r\n  getAllAccounts(): Account[] {\r\n    return Array.from(this.accounts.values());\r\n  }\r\n  \r\n  /**\r\n   * Check if an account exists\r\n   * @param accountId - ID of the account to check\r\n   * @returns true if account exists, false otherwise\r\n   */\r\n  hasAccount(accountId: string): boolean {\r\n    return this.accounts.has(accountId);\r\n  }\r\n  \r\n  /**\r\n   * Get the number of accounts\r\n   * @returns Total number of accounts\r\n   */\r\n  getAccountCount(): number {\r\n    return this.accounts.size;\r\n  }\r\n}\r\n","/**\r\n * DividendManager - 股息管理器\r\n * \r\n * 負責管理所有股息相關的業務邏輯：\r\n * - 股息記錄的 CRUD 操作（新增、讀取、更新、刪除）\r\n * - 計算調整成本價（扣除股息後的實際成本）\r\n * - 計算總股息收入\r\n * \r\n * 依賴注入：\r\n * - StorageService: 用於持久化儲存\r\n */\r\n\r\nimport { Dividend } from '../types/Dividend';\r\nimport { PortfolioData } from '../types/Portfolio';\r\nimport { StorageService } from '../services/StorageService';\r\nimport { ValidationError, StockError } from '../types/Errors';\r\n\r\n/**\r\n * 股息管理器類別\r\n * 封裝所有股息相關的業務邏輯\r\n */\r\nexport class DividendManager {\r\n  /** 股息資料儲存 - 使用 Map 結構以股息 ID 為鍵值 */\r\n  private dividends: Map<string, Dividend> = new Map();\r\n  \r\n  /**\r\n   * 建構函數 - 使用依賴注入模式\r\n   * @param storageService - 儲存服務實例\r\n   */\r\n  constructor(private storageService: StorageService) {\r\n    // 初始化時從儲存載入現有資料\r\n    this.loadFromStorage();\r\n  }\r\n  \r\n  /**\r\n   * 從儲存服務載入股息資料\r\n   * 在初始化時自動呼叫\r\n   * @private\r\n   */\r\n  private loadFromStorage(): void {\r\n    try {\r\n      const data = this.storageService.load();\r\n      \r\n      if (data && data.dividends) {\r\n        // 將股息陣列轉換為 Map 結構\r\n        for (const dividend of data.dividends) {\r\n          this.dividends.set(dividend.id, dividend);\r\n        }\r\n        \r\n        console.log(`已載入 ${this.dividends.size} 筆股息資料`);\r\n      } else {\r\n        console.log('無現有股息資料，從空白狀態開始');\r\n      }\r\n    } catch (error) {\r\n      console.error('載入股息資料失敗:', error);\r\n      // 載入失敗時從空白狀態開始\r\n      this.dividends.clear();\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * 儲存股息資料到儲存服務\r\n   * 在每次修改後自動呼叫\r\n   * @private\r\n   */\r\n  private saveToStorage(): void {\r\n    try {\r\n      // 載入完整的投資組合資料\r\n      const data = this.storageService.load() || this.createEmptyPortfolioData();\r\n      \r\n      // 更新股息陣列\r\n      data.dividends = Array.from(this.dividends.values());\r\n      \r\n      // 儲存回儲存服務\r\n      this.storageService.save(data);\r\n      \r\n      console.log(`已儲存 ${this.dividends.size} 筆股息資料`);\r\n    } catch (error) {\r\n      console.error('儲存股息資料失敗:', error);\r\n      throw new StockError('儲存股息資料失敗', 'STORAGE_ERROR');\r\n    }\r\n  }\r\n\r\n  \r\n  /**\r\n   * 建立空的投資組合資料結構\r\n   * 用於初始化或重置\r\n   * @private\r\n   * @returns 空的投資組合資料\r\n   */\r\n  private createEmptyPortfolioData(): PortfolioData {\r\n    return {\r\n      version: '1.3.0',\r\n      accounts: [],\r\n      stocks: [],\r\n      dividends: [],\r\n      settings: {\r\n        privacyMode: false,\r\n        darkMode: false,\r\n        autoUpdate: false,\r\n        updateInterval: 300000, // 5 分鐘\r\n        cloudSync: {\r\n          enabled: false\r\n        }\r\n      },\r\n      metadata: {\r\n        createdAt: new Date().toISOString(),\r\n        lastModified: new Date().toISOString()\r\n      }\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * 產生唯一的股息 ID\r\n   * 使用時間戳記和隨機數組合\r\n   * @private\r\n   * @returns 唯一的股息 ID\r\n   */\r\n  private generateDividendId(): string {\r\n    return `dividend_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n  \r\n  /**\r\n   * 新增股息記錄\r\n   * 驗證輸入資料並建立股息記錄\r\n   * \r\n   * @param dividendData - 股息資料（不含 id 和 createdAt）\r\n   * @returns 新建立的股息記錄\r\n   * @throws {ValidationError} 當輸入資料驗證失敗時\r\n   * @throws {StockError} 當新增股息失敗時\r\n   */\r\n  async addDividend(\r\n    dividendData: Omit<Dividend, 'id' | 'createdAt'>\r\n  ): Promise<Dividend> {\r\n    // 驗證股息資料\r\n    const { validateAmount, validateDate } = await import('../utils/validators');\r\n    \r\n    // 驗證每股股息金額\r\n    const dividendPerShareValidation = validateAmount(dividendData.dividendPerShare);\r\n    if (!dividendPerShareValidation.valid) {\r\n      throw new ValidationError(\r\n        dividendPerShareValidation.error || '每股股息金額格式錯誤',\r\n        'dividendPerShare'\r\n      );\r\n    }\r\n    \r\n    // 驗證總股息金額\r\n    const totalDividendValidation = validateAmount(dividendData.totalDividend);\r\n    if (!totalDividendValidation.valid) {\r\n      throw new ValidationError(\r\n        totalDividendValidation.error || '總股息金額格式錯誤',\r\n        'totalDividend'\r\n      );\r\n    }\r\n    \r\n    // 驗證除息日期\r\n    const dateValidation = validateDate(dividendData.exDividendDate, { allowFuture: true });\r\n    if (!dateValidation.valid) {\r\n      throw new ValidationError(\r\n        dateValidation.error || '除息日期格式錯誤',\r\n        'exDividendDate'\r\n      );\r\n    }\r\n    \r\n    // 驗證 stockId 不為空\r\n    if (!dividendData.stockId || dividendData.stockId.trim() === '') {\r\n      throw new ValidationError('股票 ID 不能為空', 'stockId');\r\n    }\r\n    \r\n    // 建立新股息記錄\r\n    const newDividend: Dividend = {\r\n      id: this.generateDividendId(),\r\n      stockId: dividendData.stockId,\r\n      exDividendDate: new Date(dividendData.exDividendDate).toISOString(),\r\n      dividendPerShare: dividendData.dividendPerShare,\r\n      totalDividend: dividendData.totalDividend,\r\n      createdAt: new Date().toISOString()\r\n    };\r\n    \r\n    // 儲存到 Map\r\n    this.dividends.set(newDividend.id, newDividend);\r\n    \r\n    // 持久化儲存\r\n    this.saveToStorage();\r\n    \r\n    console.log(\r\n      `✅ 新增股息記錄成功: 股票 ${newDividend.stockId}, ` +\r\n      `每股 ${newDividend.dividendPerShare}, 總計 ${newDividend.totalDividend}`\r\n    );\r\n    \r\n    return newDividend;\r\n  }\r\n  \r\n  /**\r\n   * 更新股息記錄\r\n   * 可以更新股息的任何欄位（除了 id 和 createdAt）\r\n   * \r\n   * @param dividendId - 股息 ID\r\n   * @param updates - 要更新的欄位\r\n   * @returns 更新後的股息記錄\r\n   * @throws {StockError} 當股息不存在或更新失敗時\r\n   * @throws {ValidationError} 當更新資料驗證失敗時\r\n   */\r\n  async updateDividend(\r\n    dividendId: string,\r\n    updates: Partial<Omit<Dividend, 'id' | 'createdAt'>>\r\n  ): Promise<Dividend> {\r\n    // 檢查股息是否存在\r\n    const dividend = this.dividends.get(dividendId);\r\n    if (!dividend) {\r\n      throw new StockError(`股息記錄不存在: ${dividendId}`, 'DIVIDEND_NOT_FOUND');\r\n    }\r\n    \r\n    // 驗證更新資料\r\n    const { validateAmount, validateDate } = await import('../utils/validators');\r\n    \r\n    if (updates.dividendPerShare !== undefined) {\r\n      const validation = validateAmount(updates.dividendPerShare);\r\n      if (!validation.valid) {\r\n        throw new ValidationError(\r\n          validation.error || '每股股息金額格式錯誤',\r\n          'dividendPerShare'\r\n        );\r\n      }\r\n    }\r\n    \r\n    if (updates.totalDividend !== undefined) {\r\n      const validation = validateAmount(updates.totalDividend);\r\n      if (!validation.valid) {\r\n        throw new ValidationError(\r\n          validation.error || '總股息金額格式錯誤',\r\n          'totalDividend'\r\n        );\r\n      }\r\n    }\r\n    \r\n    if (updates.exDividendDate !== undefined) {\r\n      const validation = validateDate(updates.exDividendDate, { allowFuture: true });\r\n      if (!validation.valid) {\r\n        throw new ValidationError(\r\n          validation.error || '除息日期格式錯誤',\r\n          'exDividendDate'\r\n        );\r\n      }\r\n    }\r\n    \r\n    if (updates.stockId !== undefined && updates.stockId.trim() === '') {\r\n      throw new ValidationError('股票 ID 不能為空', 'stockId');\r\n    }\r\n    \r\n    // 更新股息記錄\r\n    const updatedDividend: Dividend = {\r\n      ...dividend,\r\n      ...updates,\r\n      // 確保 exDividendDate 是 ISO 格式\r\n      exDividendDate: updates.exDividendDate\r\n        ? new Date(updates.exDividendDate).toISOString()\r\n        : dividend.exDividendDate\r\n    };\r\n    \r\n    // 儲存到 Map\r\n    this.dividends.set(dividendId, updatedDividend);\r\n    \r\n    // 持久化儲存\r\n    this.saveToStorage();\r\n    \r\n    console.log(`✅ 更新股息記錄成功: ${dividendId}`);\r\n    \r\n    return updatedDividend;\r\n  }\r\n  \r\n  /**\r\n   * 刪除股息記錄\r\n   * 從系統中完全移除股息記錄\r\n   * \r\n   * @param dividendId - 股息 ID\r\n   * @throws {StockError} 當股息不存在時\r\n   */\r\n  deleteDividend(dividendId: string): void {\r\n    // 檢查股息是否存在\r\n    const dividend = this.dividends.get(dividendId);\r\n    if (!dividend) {\r\n      throw new StockError(`股息記錄不存在: ${dividendId}`, 'DIVIDEND_NOT_FOUND');\r\n    }\r\n    \r\n    // 從 Map 中刪除\r\n    this.dividends.delete(dividendId);\r\n    \r\n    // 持久化儲存\r\n    this.saveToStorage();\r\n    \r\n    console.log(`✅ 刪除股息記錄成功: ${dividendId}`);\r\n  }\r\n  \r\n  /**\r\n   * 取得指定股票的所有股息記錄\r\n   * 根據股票 ID 篩選股息記錄，並按除息日期排序（由新到舊）\r\n   * \r\n   * @param stockId - 股票 ID\r\n   * @returns 該股票的所有股息記錄，按除息日期排序\r\n   */\r\n  getDividendsByStock(stockId: string): Dividend[] {\r\n    const stockDividends = Array.from(this.dividends.values()).filter(\r\n      dividend => dividend.stockId === stockId\r\n    );\r\n    \r\n    // 按除息日期排序（由新到舊）\r\n    return stockDividends.sort((a, b) => {\r\n      return new Date(b.exDividendDate).getTime() - new Date(a.exDividendDate).getTime();\r\n    });\r\n  }\r\n\r\n  \r\n  /**\r\n   * 計算調整成本價\r\n   * 調整成本價 = 原始成本價 - (總股息收入 / 持股數)\r\n   * \r\n   * 這個計算反映了股息收入對實際投資成本的影響。\r\n   * 當股息收入累積到一定程度，可能會使調整成本價降低，\r\n   * 甚至在極端情況下變為負數（表示已回本並有盈餘）。\r\n   * \r\n   * @param stockId - 股票 ID\r\n   * @param originalCostPrice - 原始成本價\r\n   * @param currentShares - 目前持股數\r\n   * @returns 調整後的成本價\r\n   */\r\n  calculateAdjustedCostPrice(\r\n    stockId: string,\r\n    originalCostPrice: number,\r\n    currentShares: number\r\n  ): number {\r\n    // 取得該股票的所有股息記錄\r\n    const dividends = this.getDividendsByStock(stockId);\r\n    \r\n    // 計算總股息收入\r\n    const totalDividendIncome = dividends.reduce(\r\n      (sum, dividend) => sum + dividend.totalDividend,\r\n      0\r\n    );\r\n    \r\n    // 如果沒有股息或持股數為 0，返回原始成本價\r\n    if (totalDividendIncome === 0 || currentShares === 0) {\r\n      return originalCostPrice;\r\n    }\r\n    \r\n    // 計算調整成本價\r\n    // 調整成本價 = 原始成本價 - (總股息收入 / 持股數)\r\n    const adjustedCostPrice = originalCostPrice - (totalDividendIncome / currentShares);\r\n    \r\n    return adjustedCostPrice;\r\n  }\r\n  \r\n  /**\r\n   * 計算總股息收入\r\n   * 可以計算單一股票或所有股票的總股息收入\r\n   * \r\n   * @param stockId - 股票 ID（選填，如果不提供則計算所有股票）\r\n   * @returns 總股息收入\r\n   */\r\n  calculateTotalDividend(stockId?: string): number {\r\n    let dividendsToSum: Dividend[];\r\n    \r\n    if (stockId) {\r\n      // 計算指定股票的總股息\r\n      dividendsToSum = this.getDividendsByStock(stockId);\r\n    } else {\r\n      // 計算所有股票的總股息\r\n      dividendsToSum = Array.from(this.dividends.values());\r\n    }\r\n    \r\n    // 累加總股息收入\r\n    const totalDividend = dividendsToSum.reduce(\r\n      (sum, dividend) => sum + dividend.totalDividend,\r\n      0\r\n    );\r\n    \r\n    return totalDividend;\r\n  }\r\n  \r\n  /**\r\n   * 取得所有股息記錄\r\n   * 返回系統中所有的股息記錄\r\n   * \r\n   * @returns 所有股息記錄的陣列\r\n   */\r\n  getAllDividends(): Dividend[] {\r\n    return Array.from(this.dividends.values());\r\n  }\r\n  \r\n  /**\r\n   * 取得單一股息記錄\r\n   * 根據股息 ID 查詢股息記錄\r\n   * \r\n   * @param dividendId - 股息 ID\r\n   * @returns 股息記錄，如果不存在則返回 null\r\n   */\r\n  getDividend(dividendId: string): Dividend | null {\r\n    return this.dividends.get(dividendId) || null;\r\n  }\r\n}\r\n","/**\r\n * 計算工具函數\r\n * 提供損益、報酬率、殖利率、調整成本價的計算功能\r\n * \r\n * @module calculators\r\n */\r\n\r\n/**\r\n * 計算損益\r\n * 損益 = (目前價格 - 成本價) × 持股數\r\n * \r\n * @param currentPrice - 目前股價\r\n * @param costPrice - 成本價\r\n * @param shares - 持股數\r\n * @returns 損益金額（正數為獲利，負數為虧損）\r\n * \r\n * @example\r\n * calculateGain(550, 500, 1000) // 50000 (獲利 5 萬)\r\n * calculateGain(450, 500, 1000) // -50000 (虧損 5 萬)\r\n */\r\nexport function calculateGain(\r\n  currentPrice: number,\r\n  costPrice: number,\r\n  shares: number\r\n): number {\r\n  if (\r\n    typeof currentPrice !== 'number' ||\r\n    typeof costPrice !== 'number' ||\r\n    typeof shares !== 'number' ||\r\n    isNaN(currentPrice) ||\r\n    isNaN(costPrice) ||\r\n    isNaN(shares)\r\n  ) {\r\n    return 0;\r\n  }\r\n  \r\n  return (currentPrice - costPrice) * shares;\r\n}\r\n\r\n/**\r\n * 計算報酬率\r\n * 報酬率 = (目前價格 - 成本價) / 成本價\r\n * \r\n * @param currentPrice - 目前股價\r\n * @param costPrice - 成本價\r\n * @returns 報酬率（小數形式，例如 0.1 表示 10%）\r\n * \r\n * @example\r\n * calculateReturnRate(550, 500) // 0.1 (10%)\r\n * calculateReturnRate(450, 500) // -0.1 (-10%)\r\n */\r\nexport function calculateReturnRate(\r\n  currentPrice: number,\r\n  costPrice: number\r\n): number {\r\n  if (\r\n    typeof currentPrice !== 'number' ||\r\n    typeof costPrice !== 'number' ||\r\n    isNaN(currentPrice) ||\r\n    isNaN(costPrice) ||\r\n    costPrice === 0\r\n  ) {\r\n    return 0;\r\n  }\r\n  \r\n  return (currentPrice - costPrice) / costPrice;\r\n}\r\n\r\n/**\r\n * 計算殖利率\r\n * 殖利率 = 年度股息 / 目前股價\r\n * \r\n * @param annualDividend - 年度股息（每股）\r\n * @param currentPrice - 目前股價\r\n * @returns 殖利率（小數形式，例如 0.05 表示 5%）\r\n * \r\n * @example\r\n * calculateYield(5, 100) // 0.05 (5%)\r\n * calculateYield(10, 200) // 0.05 (5%)\r\n */\r\nexport function calculateYield(\r\n  annualDividend: number,\r\n  currentPrice: number\r\n): number {\r\n  if (\r\n    typeof annualDividend !== 'number' ||\r\n    typeof currentPrice !== 'number' ||\r\n    isNaN(annualDividend) ||\r\n    isNaN(currentPrice) ||\r\n    currentPrice === 0\r\n  ) {\r\n    return 0;\r\n  }\r\n  \r\n  return annualDividend / currentPrice;\r\n}\r\n\r\n/**\r\n * 計算調整成本價（考慮股息）\r\n * 調整成本價 = (原始成本 - 累計股息) / 持股數\r\n * \r\n * 當股票發放股息時，實際成本會降低\r\n * 例如：買入 1000 股，成本價 100 元，收到股息 5000 元\r\n * 調整成本價 = (100000 - 5000) / 1000 = 95 元\r\n * \r\n * @param originalCost - 原始總成本（成本價 × 持股數）\r\n * @param totalDividend - 累計收到的股息總額\r\n * @param shares - 持股數\r\n * @returns 調整後的成本價（每股）\r\n * \r\n * @example\r\n * calculateAdjustedCost(100000, 5000, 1000) // 95\r\n * calculateAdjustedCost(500000, 25000, 1000) // 475\r\n */\r\nexport function calculateAdjustedCost(\r\n  originalCost: number,\r\n  totalDividend: number,\r\n  shares: number\r\n): number {\r\n  if (\r\n    typeof originalCost !== 'number' ||\r\n    typeof totalDividend !== 'number' ||\r\n    typeof shares !== 'number' ||\r\n    isNaN(originalCost) ||\r\n    isNaN(totalDividend) ||\r\n    isNaN(shares) ||\r\n    shares === 0\r\n  ) {\r\n    return 0;\r\n  }\r\n  \r\n  const adjustedCost = (originalCost - totalDividend) / shares;\r\n  \r\n  // 調整成本價不應為負數（股息超過成本的情況）\r\n  return Math.max(0, adjustedCost);\r\n}\r\n\r\n/**\r\n * 計算總報酬率（含股息）\r\n * 總報酬率 = (目前市值 + 累計股息 - 原始成本) / 原始成本\r\n * \r\n * @param currentPrice - 目前股價\r\n * @param costPrice - 成本價\r\n * @param shares - 持股數\r\n * @param totalDividend - 累計收到的股息總額\r\n * @returns 總報酬率（小數形式，例如 0.15 表示 15%）\r\n * \r\n * @example\r\n * calculateTotalReturn(550, 500, 1000, 10000) // 0.12 (12%)\r\n * // 說明：目前市值 550000，原始成本 500000，股息 10000\r\n * // 總報酬 = (550000 + 10000 - 500000) / 500000 = 0.12\r\n */\r\nexport function calculateTotalReturn(\r\n  currentPrice: number,\r\n  costPrice: number,\r\n  shares: number,\r\n  totalDividend: number\r\n): number {\r\n  if (\r\n    typeof currentPrice !== 'number' ||\r\n    typeof costPrice !== 'number' ||\r\n    typeof shares !== 'number' ||\r\n    typeof totalDividend !== 'number' ||\r\n    isNaN(currentPrice) ||\r\n    isNaN(costPrice) ||\r\n    isNaN(shares) ||\r\n    isNaN(totalDividend) ||\r\n    costPrice === 0 ||\r\n    shares === 0\r\n  ) {\r\n    return 0;\r\n  }\r\n  \r\n  const currentValue = currentPrice * shares;\r\n  const originalCost = costPrice * shares;\r\n  const totalReturn = (currentValue + totalDividend - originalCost) / originalCost;\r\n  \r\n  return totalReturn;\r\n}\r\n\r\n/**\r\n * 計算平均成本價（加碼時使用）\r\n * 平均成本價 = (原有成本 + 新增成本) / (原有股數 + 新增股數)\r\n * \r\n * @param existingShares - 原有持股數\r\n * @param existingCostPrice - 原有成本價\r\n * @param newShares - 新增持股數\r\n * @param newCostPrice - 新增成本價\r\n * @returns 平均成本價\r\n * \r\n * @example\r\n * calculateAverageCost(1000, 100, 500, 110) // 103.33\r\n * // 說明：原有 1000 股 @ 100 元，加碼 500 股 @ 110 元\r\n * // 平均成本 = (100000 + 55000) / 1500 = 103.33\r\n */\r\nexport function calculateAverageCost(\r\n  existingShares: number,\r\n  existingCostPrice: number,\r\n  newShares: number,\r\n  newCostPrice: number\r\n): number {\r\n  if (\r\n    typeof existingShares !== 'number' ||\r\n    typeof existingCostPrice !== 'number' ||\r\n    typeof newShares !== 'number' ||\r\n    typeof newCostPrice !== 'number' ||\r\n    isNaN(existingShares) ||\r\n    isNaN(existingCostPrice) ||\r\n    isNaN(newShares) ||\r\n    isNaN(newCostPrice)\r\n  ) {\r\n    return 0;\r\n  }\r\n  \r\n  const totalShares = existingShares + newShares;\r\n  \r\n  if (totalShares === 0) {\r\n    return 0;\r\n  }\r\n  \r\n  const totalCost = (existingShares * existingCostPrice) + (newShares * newCostPrice);\r\n  \r\n  return totalCost / totalShares;\r\n}\r\n","/**\r\n * PortfolioManager - 投資組合管理器\r\n * \r\n * 負責協調各個管理器並計算投資組合統計資料：\r\n * - 計算投資組合整體統計（總市值、總損益、總報酬率等）\r\n * - 計算單一帳戶統計\r\n * - 計算總體統計（所有帳戶彙總）\r\n * \r\n * 依賴注入：\r\n * - StockManager: 用於取得股票資料\r\n * - AccountManager: 用於取得帳戶資料\r\n * - DividendManager: 用於取得股息資料\r\n */\r\n\r\nimport { PortfolioStats } from '../types/Portfolio';\r\nimport { StockManager } from './StockManager';\r\nimport { AccountManager } from './AccountManager';\r\nimport { DividendManager } from './DividendManager';\r\nimport { calculateGain } from '../utils/calculators';\r\n// calculateTotalReturn 暫時未使用，保留供未來功能擴展\r\n// import { calculateTotalReturn } from '../utils/calculators';\r\n\r\n/**\r\n * 投資組合管理器類別\r\n * 協調各個管理器並提供統計計算功能\r\n */\r\nexport class PortfolioManager {\r\n  /**\r\n   * 建構函數 - 使用依賴注入模式\r\n   * @param stockManager - 股票管理器實例\r\n   * @param accountManager - 帳戶管理器實例\r\n   * @param dividendManager - 股息管理器實例\r\n   */\r\n  constructor(\r\n    private stockManager: StockManager,\r\n    private accountManager: AccountManager,\r\n    private dividendManager: DividendManager\r\n  ) {}\r\n  \r\n  /**\r\n   * 計算投資組合統計\r\n   * 根據提供的股票列表計算統計資料\r\n   * \r\n   * @param stocks - 股票列表（可以是所有股票或特定帳戶的股票）\r\n   * @returns 投資組合統計資料\r\n   * @private\r\n   */\r\n  private calculateStats(stocks: Array<{\r\n    id: string;\r\n    code: string;\r\n    name: string;\r\n    shares: number;\r\n    costPrice: number;\r\n    currentPrice: number;\r\n  }>): PortfolioStats {\r\n    // 初始化統計資料\r\n    let totalValue = 0;      // 總市值\r\n    let totalCost = 0;       // 總成本\r\n    let totalGain = 0;       // 總損益\r\n    let totalDividend = 0;   // 總股息收入\r\n    \r\n    // 遍歷所有股票計算統計\r\n    for (const stock of stocks) {\r\n      // 計算該股票的市值和成本\r\n      const stockValue = stock.currentPrice * stock.shares;\r\n      const stockCost = stock.costPrice * stock.shares;\r\n      \r\n      // 計算該股票的損益\r\n      const stockGain = calculateGain(\r\n        stock.currentPrice,\r\n        stock.costPrice,\r\n        stock.shares\r\n      );\r\n      \r\n      // 計算該股票的股息收入\r\n      const stockDividend = this.dividendManager.calculateTotalDividend(stock.id);\r\n      \r\n      // 累加到總計\r\n      totalValue += stockValue;\r\n      totalCost += stockCost;\r\n      totalGain += stockGain;\r\n      totalDividend += stockDividend;\r\n    }\r\n    \r\n    // 計算百分比\r\n    // 避免除以零的情況\r\n    const totalGainPercent = totalCost > 0 ? (totalGain / totalCost) * 100 : 0;\r\n    \r\n    // 計算總報酬（損益 + 股息）\r\n    const totalReturn = totalGain + totalDividend;\r\n    const totalReturnPercent = totalCost > 0 ? (totalReturn / totalCost) * 100 : 0;\r\n    \r\n    return {\r\n      totalValue,\r\n      totalCost,\r\n      totalGain,\r\n      totalGainPercent,\r\n      totalDividend,\r\n      totalReturn,\r\n      totalReturnPercent\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * 計算單一帳戶的統計資料\r\n   * 只計算指定帳戶的股票\r\n   * \r\n   * @param accountId - 帳戶 ID\r\n   * @returns 該帳戶的投資組合統計資料\r\n   * @throws {Error} 當帳戶不存在時\r\n   */\r\n  getAccountStats(accountId: string): PortfolioStats {\r\n    // 驗證帳戶是否存在\r\n    const account = this.accountManager.getAccount(accountId);\r\n    if (!account) {\r\n      throw new Error(`帳戶不存在: ${accountId}`);\r\n    }\r\n    \r\n    // 取得該帳戶的所有股票\r\n    const accountStocks = this.stockManager.getStocksByAccount(accountId);\r\n    \r\n    // 計算統計資料\r\n    const stats = this.calculateStats(accountStocks);\r\n    \r\n    console.log(`計算帳戶統計: ${account.name} - 總市值 ${stats.totalValue}, 總報酬率 ${stats.totalReturnPercent.toFixed(2)}%`);\r\n    \r\n    return stats;\r\n  }\r\n  \r\n  /**\r\n   * 計算總體統計資料\r\n   * 計算所有帳戶的股票彙總統計\r\n   * \r\n   * @returns 總體投資組合統計資料\r\n   */\r\n  getTotalStats(): PortfolioStats {\r\n    // 取得所有股票\r\n    const allStocks = this.stockManager.getAllStocks();\r\n    \r\n    // 計算統計資料\r\n    const stats = this.calculateStats(allStocks);\r\n    \r\n    console.log(`計算總體統計: 總市值 ${stats.totalValue}, 總報酬率 ${stats.totalReturnPercent.toFixed(2)}%`);\r\n    \r\n    return stats;\r\n  }\r\n  \r\n  /**\r\n   * 計算投資組合統計（通用方法）\r\n   * 可以指定帳戶 ID 或計算所有帳戶\r\n   * \r\n   * @param accountId - 帳戶 ID（選填，如果不提供則計算所有帳戶）\r\n   * @returns 投資組合統計資料\r\n   */\r\n  calculatePortfolioStats(accountId?: string): PortfolioStats {\r\n    if (accountId) {\r\n      // 計算指定帳戶的統計\r\n      return this.getAccountStats(accountId);\r\n    } else {\r\n      // 計算總體統計\r\n      return this.getTotalStats();\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * 取得所有帳戶的統計資料\r\n   * 返回每個帳戶的統計資料陣列\r\n   * \r\n   * @returns 所有帳戶的統計資料陣列\r\n   */\r\n  getAllAccountStats(): Array<{\r\n    accountId: string;\r\n    accountName: string;\r\n    stats: PortfolioStats;\r\n  }> {\r\n    const accounts = this.accountManager.getAllAccounts();\r\n    \r\n    return accounts.map(account => ({\r\n      accountId: account.id,\r\n      accountName: account.name,\r\n      stats: this.getAccountStats(account.id)\r\n    }));\r\n  }\r\n  \r\n  /**\r\n   * 取得投資組合摘要\r\n   * 包含總體統計和各帳戶統計\r\n   * \r\n   * @returns 完整的投資組合摘要\r\n   */\r\n  getPortfolioSummary(): {\r\n    totalStats: PortfolioStats;\r\n    accountStats: Array<{\r\n      accountId: string;\r\n      accountName: string;\r\n      stats: PortfolioStats;\r\n    }>;\r\n    stockCount: number;\r\n    accountCount: number;\r\n  } {\r\n    const totalStats = this.getTotalStats();\r\n    const accountStats = this.getAllAccountStats();\r\n    const stockCount = this.stockManager.getAllStocks().length;\r\n    const accountCount = this.accountManager.getAccountCount();\r\n    \r\n    return {\r\n      totalStats,\r\n      accountStats,\r\n      stockCount,\r\n      accountCount\r\n    };\r\n  }\r\n}\r\n"],"file":"js/managers.DxU0Vghc.js"}